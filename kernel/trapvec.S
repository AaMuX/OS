#主管模式(S-mode)异常/中断入口，负责在发生中断或异常时，
#保存CPU状态，调用C语言处理函数，然后恢复状态返回。是操作系统的异常/中断处理的汇编入口点。
.section .text           # 指定代码段
    .align 2                 # 4字节对齐（2^2=4），RISC-V要求
    .globl kernelvec         # 声明为全局符号，可被外部引用
    .type kernelvec, @function  # 指定kernelvec是一个函数

    .equ TRAPFRAME_SIZE, 288  # 定义陷阱帧结构体大小：36个8字节寄存器 = 288字节

# kernelvec: 主管模式(S-mode)异常/中断向量入口
# 作用：当CPU运行在主管模式时发生异常或中断，CPU跳转至此
# 主要功能：
# 1. 保存全部寄存器状态到栈上（构建trapframe）
# 2. 调用C语言异常处理函数kerneltrap()
# 3. 恢复寄存器状态并返回
# 4. 支持嵌套中断处理

kernelvec:
    # 保存寄存器现场（进入内核栈）
    addi    sp, sp, -TRAPFRAME_SIZE  # 在栈上分配陷阱帧空间
    # 栈帧布局（相对于sp的偏移量）：
    #   0-7: ra (返回地址)
    #   8-15: 原始栈指针 (t0临时保存)
    #   16-23: gp (全局指针)
    #   24-31: tp (线程指针)
    #   32-39: t0 (临时寄存器0)
    #   40-47: t1 (临时寄存器1)
    #   48-55: t2 (临时寄存器2)
    #   56-63: s0 (保存寄存器0/fp)
    #   64-71: s1 (保存寄存器1)
    #   72-79: a0 (参数寄存器0)
    #   ... 其他参数寄存器
    #   128-135: a7 (参数寄存器7)
    #   136-143: s2 (保存寄存器2)
    #   ... 其他保存寄存器
    #   208-215: s11 (保存寄存器11)
    #   216-223: t3 (临时寄存器3)
    #   224-231: t4 (临时寄存器4)
    #   232-239: t5 (临时寄存器5)
    #   240-247: t6 (临时寄存器6)
    #   248-255: 未使用
    #   256-263: 未使用
    #   264-271: 未使用
    #   272-279: 未使用
    #   280-287: 未使用

    # 保存通用寄存器
    sd      ra, 0(sp)          # 保存返回地址寄存器
    sd      t0, 32(sp)         # 保存t0（先保存，后面用）
    addi    t0, sp, TRAPFRAME_SIZE
    sd      t0, 8(sp)          # 保存中断前的栈指针到陷阱帧
    sd      gp, 16(sp)         # 保存全局指针
    sd      tp, 24(sp)         # 保存线程指针
    sd      t1, 40(sp)         # 保存t1
    sd      t2, 48(sp)         # 保存t2
    sd      s0, 56(sp)         # 保存s0/fp
    sd      s1, 64(sp)         # 保存s1
    sd      a0, 72(sp)         # 保存a0 (参数寄存器0)
    sd      a1, 80(sp)         # 保存a1 (参数寄存器1)
    sd      a2, 88(sp)         # 保存a2 (参数寄存器2)
    sd      a3, 96(sp)         # 保存a3 (参数寄存器3)
    sd      a4, 104(sp)        # 保存a4 (参数寄存器4)
    sd      a5, 112(sp)        # 保存a5 (参数寄存器5)
    sd      a6, 120(sp)        # 保存a6 (参数寄存器6)
    sd      a7, 128(sp)        # 保存a7 (参数寄存器7)
    sd      s2, 136(sp)        # 保存s2
    sd      s3, 144(sp)        # 保存s3
    sd      s4, 152(sp)        # 保存s4
    sd      s5, 160(sp)        # 保存s5
    sd      s6, 168(sp)        # 保存s6
    sd      s7, 176(sp)        # 保存s7
    sd      s8, 184(sp)        # 保存s8
    sd      s9, 192(sp)        # 保存s9
    sd      s10, 200(sp)       # 保存s10
    sd      s11, 208(sp)       # 保存s11
    sd      t3, 216(sp)        # 保存t3
    sd      t4, 224(sp)        # 保存t4
    sd      t5, 232(sp)        # 保存t5
    sd      t6, 240(sp)        # 保存t6

    # 调用C语言异常处理函数
    mv      a0, sp             # 参数a0 = 指向陷阱帧的指针
    call    kerneltrap         # 调用C语言异常处理函数
    # kerneltrap将处理中断/异常，并可能返回修改后的sepc

    # 恢复寄存器现场
    ld      t6, 240(sp)        # 恢复t6
    ld      t5, 232(sp)        # 恢复t5
    ld      t4, 224(sp)        # 恢复t4
    ld      t3, 216(sp)        # 恢复t3
    ld      s11, 208(sp)       # 恢复s11
    ld      s10, 200(sp)       # 恢复s10
    ld      s9, 192(sp)        # 恢复s9
    ld      s8, 184(sp)        # 恢复s8
    ld      s7, 176(sp)        # 恢复s7
    ld      s6, 168(sp)        # 恢复s6
    ld      s5, 160(sp)        # 恢复s5
    ld      s4, 152(sp)        # 恢复s4
    ld      s3, 144(sp)        # 恢复s3
    ld      s2, 136(sp)        # 恢复s2
    ld      a7, 128(sp)        # 恢复a7
    ld      a6, 120(sp)        # 恢复a6
    ld      a5, 112(sp)        # 恢复a5
    ld      a4, 104(sp)        # 恢复a4
    ld      a3, 96(sp)         # 恢复a3
    ld      a2, 88(sp)         # 恢复a2
    ld      a1, 80(sp)         # 恢复a1
    ld      a0, 72(sp)         # 恢复a0
    ld      s1, 64(sp)         # 恢复s1
    ld      s0, 56(sp)         # 恢复s0/fp
    ld      t2, 48(sp)         # 恢复t2
    ld      t1, 40(sp)         # 恢复t1
    ld      t0, 32(sp)         # 恢复t0
    ld      tp, 24(sp)         # 恢复线程指针
    ld      gp, 16(sp)         # 恢复全局指针
    ld      ra, 0(sp)          # 恢复返回地址

    # 恢复栈指针并返回
    addi    sp, sp, TRAPFRAME_SIZE  # 释放栈空间
    sret                         # 从异常返回